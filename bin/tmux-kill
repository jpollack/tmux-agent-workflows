#!/usr/bin/env bash
set -euo pipefail

PROG="tmux-kill"
DEFAULT_PREFIX="agent"

usage() {
    cat <<EOF
Usage: $PROG --name NAME [options]

Kill a named tmux pane and its process.

Options:
  --name NAME     Target pane name (required)
  --prefix NAME   Session prefix (default: $DEFAULT_PREFIX)
  --help          Show this help

Examples:
  $PROG --name server         # Kill the "server" pane
  $PROG --name build          # Kill the "build" pane
EOF
}

parse_args() {
    PREFIX="$DEFAULT_PREFIX"
    NAME=""
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --name) NAME="$2"; shift 2 ;;
            --prefix) PREFIX="$2"; shift 2 ;;
            --help) usage; exit 0 ;;
            *) echo "Error: unknown argument '$1'" >&2; usage >&2; exit 1 ;;
        esac
    done
    if [[ -z "$NAME" ]]; then
        echo "Error: --name is required" >&2; usage >&2; exit 1
    fi
}

find_pane() {
    local idx
    idx=$(tmux list-windows -t "$PREFIX" -F '#{window_index}:#{window_name}' 2>/dev/null | grep ":${1}$" | head -1 | cut -d: -f1)
    if [[ -z "$idx" ]]; then
        echo "Error: pane '$1' not found in session '$PREFIX'" >&2
        exit 1
    fi
    echo "$PREFIX:$idx"
}

parse_args "$@"

TARGET=$(find_pane "$NAME")
tmux kill-window -t "$TARGET"
echo "Killed '$NAME' in session '$PREFIX'"
