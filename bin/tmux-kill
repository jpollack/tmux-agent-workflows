#!/usr/bin/env bash
set -euo pipefail
source "$(dirname "$0")/_tmux-common"

PROG="tmux-kill"
DEFAULT_PREFIX="agent"

usage() {
    cat <<EOF
Usage: $PROG (--name NAME | --all) [options]

Kill a named tmux pane and its process, or kill all panes.

Options:
  --name NAME     Target pane name
  --all           Kill all panes (except _init)
  --prefix NAME   Session prefix (default: $DEFAULT_PREFIX)
  --quiet, -q     Suppress informational output
  --help          Show this help

Examples:
  $PROG --name server         # Kill the "server" pane
  $PROG --name build          # Kill the "build" pane
  $PROG --all                 # Kill all panes
EOF
}

parse_args() {
    PREFIX="$DEFAULT_PREFIX"
    NAME=""
    ALL=false
    QUIET=false
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --name) [[ $# -ge 2 ]] || { echo "Error: --name requires a value" >&2; exit 1; }; NAME="$2"; shift 2 ;;
            --all) ALL=true; shift ;;
            --prefix) [[ $# -ge 2 ]] || { echo "Error: --prefix requires a value" >&2; exit 1; }; PREFIX="$2"; shift 2 ;;
            --quiet|-q) QUIET=true; shift ;;
            --help) usage; exit 0 ;;
            *) echo "Error: unknown argument '$1'" >&2; usage >&2; exit 1 ;;
        esac
    done
    if [[ "$ALL" == false && -z "$NAME" ]]; then
        echo "Error: --name or --all is required" >&2; usage >&2; exit 1
    fi
    if [[ "$ALL" == true && -n "$NAME" ]]; then
        echo "Error: --name and --all are mutually exclusive" >&2; exit 1
    fi
}

parse_args "$@"

validate_name "prefix" "$PREFIX" || exit 1

if [[ "$ALL" == true ]]; then
    if ! session_exists "$PREFIX"; then
        echo "Error: session '$PREFIX' does not exist" >&2
        exit 1
    fi
    tmux list-windows -t "$PREFIX" -F '#{window_index}|#{window_name}' 2>/dev/null | while IFS='|' read -r idx name; do
        [[ "$name" == "_init" ]] && continue
        tmux kill-window -t "$PREFIX:$idx" 2>/dev/null || true
    done
    [[ "$QUIET" == true ]] || echo "Killed all panes in session '$PREFIX'"
else
    validate_name "name" "$NAME" || exit 1
    TARGET=$(find_pane "$PREFIX" "$NAME")
    tmux kill-window -t "$TARGET"
    [[ "$QUIET" == true ]] || echo "Killed '$NAME' in session '$PREFIX'"
fi
