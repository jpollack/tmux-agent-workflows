#!/usr/bin/env bash
set -euo pipefail
source "$(dirname "$0")/_tmux-common"

PROG="tmux-read"
DEFAULT_PREFIX="agent"

usage() {
    cat <<EOF
Usage: $PROG --name NAME [options]

Read output from a named tmux pane.

Options:
  --name NAME     Target pane name (required)
  --prefix NAME   Session prefix (default: $DEFAULT_PREFIX)
  --last N        Show only last N lines (alias: --tail)
  --start N       Skip first N lines
  --grep PATTERN  Wait for fixed string PATTERN to appear in output
  --grep-regex    Treat --grep PATTERN as extended regex instead of fixed string
  --grep-invert   Succeed when PATTERN is NOT found (wait for disappearance)
  --timeout SECS  Max seconds to wait for --grep (default: 0 = forever)
  --poll SECS     Polling interval for --grep (default: 2)
  --history N     Scrollback lines to capture (default: 1000)
  --help          Show this help

Output is written to stdout. Pipe or redirect as needed.

Examples:
  $PROG --name build                   # All visible output
  $PROG --name build --last 20         # Last 20 lines
  $PROG --name server | grep ERROR     # Filter output
EOF
}

parse_args() {
    PREFIX="$DEFAULT_PREFIX"
    NAME=""
    LAST=""
    START=""
    GREP=""
    GREP_REGEX=false
    GREP_INVERT=false
    GREP_TIMEOUT=0
    GREP_POLL=2
    HISTORY=1000
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --name) [[ $# -ge 2 ]] || { echo "Error: --name requires a value" >&2; exit 1; }; NAME="$2"; shift 2 ;;
            --prefix) [[ $# -ge 2 ]] || { echo "Error: --prefix requires a value" >&2; exit 1; }; PREFIX="$2"; shift 2 ;;
            --last|--tail) [[ $# -ge 2 ]] || { echo "Error: $1 requires a value" >&2; exit 1; }; LAST="$2"; shift 2 ;;
            --start) [[ $# -ge 2 ]] || { echo "Error: --start requires a value" >&2; exit 1; }; START="$2"; shift 2 ;;
            --grep) [[ $# -ge 2 ]] || { echo "Error: --grep requires a value" >&2; exit 1; }; GREP="$2"; shift 2 ;;
            --grep-regex) GREP_REGEX=true; shift ;;
            --grep-invert) GREP_INVERT=true; shift ;;
            --timeout) [[ $# -ge 2 ]] || { echo "Error: --timeout requires a value" >&2; exit 1; }; GREP_TIMEOUT="$2"; shift 2 ;;
            --poll) [[ $# -ge 2 ]] || { echo "Error: --poll requires a value" >&2; exit 1; }; GREP_POLL="$2"; shift 2 ;;
            --history) [[ $# -ge 2 ]] || { echo "Error: --history requires a value" >&2; exit 1; }; HISTORY="$2"; shift 2 ;;
            --help) usage; exit 0 ;;
            *) echo "Error: unknown argument '$1'" >&2; usage >&2; exit 1 ;;
        esac
    done
    if [[ -z "$NAME" ]]; then
        echo "Error: --name is required" >&2; usage >&2; exit 1
    fi
}

parse_args "$@"

validate_name "name" "$NAME" || exit 1
validate_name "prefix" "$PREFIX" || exit 1

TARGET=$(find_pane "$PREFIX" "$NAME")

strip_output() {
    grep -v '^Pane is dead' | sed -e :a -e '/^[[:space:]]*$/{ $d; N; ba; }'
}

apply_filters() {
    local result
    result=$(strip_output)
    if [[ -n "$START" ]]; then
        result=$(echo "$result" | tail -n +"$((START + 1))")
    fi
    if [[ -n "$LAST" ]]; then
        result=$(echo "$result" | tail -n "$LAST")
    fi
    [[ -n "$result" ]] && echo "$result" || true
}

if [[ -n "$GREP" ]]; then
    if [[ "$GREP_POLL" -le 0 ]]; then
        echo "Error: --poll must be positive" >&2
        exit 1
    fi
    if [[ "$GREP_REGEX" == true ]]; then
        GREP_FLAG="-qE"
    else
        GREP_FLAG="-qF"
    fi
    elapsed=0
    while true; do
        OUTPUT=$(tmux capture-pane -t "$TARGET" -p -S -"$HISTORY" -J)
        if [[ "$GREP_INVERT" == true ]]; then
            if ! echo "$OUTPUT" | grep $GREP_FLAG "$GREP"; then
                echo "$OUTPUT" | apply_filters
                exit 0
            fi
        else
            if echo "$OUTPUT" | grep $GREP_FLAG "$GREP"; then
                echo "$OUTPUT" | apply_filters
                exit 0
            fi
        fi
        # Check if pane is dead â€” output will never change
        pane_dead=$(tmux display-message -t "$TARGET" -p '#{pane_dead}' 2>/dev/null || echo "1")
        if [[ "$pane_dead" == "1" ]]; then
            if [[ "$GREP_INVERT" == true ]]; then
                echo "Error: pattern '$GREP' still present; pane '${TARGET}' has exited" >&2
            else
                echo "Error: pattern '$GREP' not found; pane '${TARGET}' has exited" >&2
            fi
            exit 1
        fi
        if [[ "$GREP_TIMEOUT" -gt 0 && "$elapsed" -ge "$GREP_TIMEOUT" ]]; then
            echo "Timeout waiting for '$GREP' after ${GREP_TIMEOUT}s" >&2
            exit 124
        fi
        sleep "$GREP_POLL"
        elapsed=$((elapsed + GREP_POLL))
    done
else
    OUTPUT=$(tmux capture-pane -t "$TARGET" -p -S -"$HISTORY" -J)
    echo "$OUTPUT" | apply_filters
fi
