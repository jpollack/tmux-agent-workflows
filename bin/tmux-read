#!/usr/bin/env bash
set -euo pipefail
source "$(dirname "$0")/_tmux-common"

PROG="tmux-read"
DEFAULT_PREFIX="agent"

usage() {
    cat <<EOF
Usage: $PROG --name NAME [options]

Read output from a named tmux pane.

Options:
  --name NAME     Target pane name (required)
  --prefix NAME   Session prefix (default: $DEFAULT_PREFIX)
  --last N        Show only last N lines
  --start N       Skip first N lines
  --grep PATTERN  Wait for PATTERN to appear in output
  --timeout SECS  Max seconds to wait for --grep (default: 0 = forever)
  --poll SECS     Polling interval for --grep (default: 2)
  --help          Show this help

Output is written to stdout. Pipe or redirect as needed.

Examples:
  $PROG --name build                   # All visible output
  $PROG --name build --last 20         # Last 20 lines
  $PROG --name server | grep ERROR     # Filter output
EOF
}

parse_args() {
    PREFIX="$DEFAULT_PREFIX"
    NAME=""
    LAST=""
    START=""
    GREP=""
    GREP_TIMEOUT=0
    GREP_POLL=2
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --name) NAME="$2"; shift 2 ;;
            --prefix) PREFIX="$2"; shift 2 ;;
            --last) LAST="$2"; shift 2 ;;
            --start) START="$2"; shift 2 ;;
            --grep) GREP="$2"; shift 2 ;;
            --timeout) GREP_TIMEOUT="$2"; shift 2 ;;
            --poll) GREP_POLL="$2"; shift 2 ;;
            --help) usage; exit 0 ;;
            *) echo "Error: unknown argument '$1'" >&2; usage >&2; exit 1 ;;
        esac
    done
    if [[ -z "$NAME" ]]; then
        echo "Error: --name is required" >&2; usage >&2; exit 1
    fi
}

parse_args "$@"

validate_name "name" "$NAME" || exit 1
validate_name "prefix" "$PREFIX" || exit 1

TARGET=$(find_pane "$PREFIX" "$NAME")

strip_output() {
    grep -v '^Pane is dead' | sed -e :a -e '/^[[:space:]]*$/{ $d; N; ba; }'
}

apply_filters() {
    local result
    result=$(strip_output)
    if [[ -n "$START" ]]; then
        result=$(echo "$result" | tail -n +"$((START + 1))")
    fi
    if [[ -n "$LAST" ]]; then
        result=$(echo "$result" | tail -n "$LAST")
    fi
    echo "$result"
}

if [[ -n "$GREP" ]]; then
    if [[ "$GREP_POLL" -le 0 ]]; then
        echo "Error: --poll must be positive" >&2
        exit 1
    fi
    elapsed=0
    while true; do
        OUTPUT=$(tmux capture-pane -t "$TARGET" -p -S -1000 -J)
        if echo "$OUTPUT" | grep -qF "$GREP"; then
            echo "$OUTPUT" | apply_filters
            exit 0
        fi
        if [[ "$GREP_TIMEOUT" -gt 0 && "$elapsed" -ge "$GREP_TIMEOUT" ]]; then
            echo "Timeout waiting for '$GREP' after ${GREP_TIMEOUT}s" >&2
            exit 124
        fi
        sleep "$GREP_POLL"
        elapsed=$((elapsed + GREP_POLL))
    done
else
    OUTPUT=$(tmux capture-pane -t "$TARGET" -p -S -1000 -J)
    echo "$OUTPUT" | apply_filters
fi
