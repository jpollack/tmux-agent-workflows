#!/usr/bin/env bash
set -euo pipefail
source "$(dirname "$0")/_tmux-common"

PROG="tmux-send"
DEFAULT_PREFIX="agent"

usage() {
    cat <<EOF
Usage: $PROG --name NAME [options] (--text TEXT | --keys KEYS)

Send input to a named tmux pane.

Options:
  --name NAME     Target pane name (required)
  --prefix NAME   Session prefix (default: $DEFAULT_PREFIX)
  --text TEXT     Send text literally (no trailing Enter)
  --keys KEYS     Send tmux key names (e.g. Enter, C-c, Escape)
  --help          Show this help

Examples:
  $PROG --name server --text "quit"
  $PROG --name server --keys Enter
  $PROG --name server --keys C-c          # Send Ctrl-C
  $PROG --name build --text "make" --keys Enter
EOF
}

parse_args() {
    PREFIX="$DEFAULT_PREFIX"
    NAME=""
    TEXT=""
    KEYS=""
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --name) [[ $# -ge 2 ]] || { echo "Error: --name requires a value" >&2; exit 1; }; NAME="$2"; shift 2 ;;
            --prefix) [[ $# -ge 2 ]] || { echo "Error: --prefix requires a value" >&2; exit 1; }; PREFIX="$2"; shift 2 ;;
            --text) [[ $# -ge 2 ]] || { echo "Error: --text requires a value" >&2; exit 1; }; TEXT="$2"; shift 2 ;;
            --keys) [[ $# -ge 2 ]] || { echo "Error: --keys requires a value" >&2; exit 1; }; KEYS="$2"; shift 2 ;;
            --help) usage; exit 0 ;;
            *) echo "Error: unknown argument '$1'" >&2; usage >&2; exit 1 ;;
        esac
    done
    if [[ -z "$NAME" ]]; then
        echo "Error: --name is required" >&2; usage >&2; exit 1
    fi
    if [[ -z "$TEXT" && -z "$KEYS" ]]; then
        echo "Error: --text or --keys required" >&2; usage >&2; exit 1
    fi
}

parse_args "$@"

validate_name "name" "$NAME" || exit 1
validate_name "prefix" "$PREFIX" || exit 1

TARGET=$(find_pane "$PREFIX" "$NAME")

# Check if pane is dead
PANE_DEAD=$(tmux list-windows -t "$PREFIX" -F '#{window_name}|#{pane_dead}' 2>/dev/null \
    | awk -F'|' -v name="$NAME" '$1 == name {print $2; exit}')
if [[ "$PANE_DEAD" == "1" ]]; then
    echo "Error: pane '$NAME' is dead; cannot send input" >&2
    exit 1
fi

if [[ -n "$TEXT" ]]; then
    tmux send-keys -t "$TARGET" -l "$TEXT"
fi
if [[ -n "$KEYS" ]]; then
    tmux send-keys -t "$TARGET" "$KEYS"
fi
