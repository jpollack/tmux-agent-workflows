#!/usr/bin/env bash
set -euo pipefail

PROG="tmux-run"
DEFAULT_PREFIX="agent"

usage() {
    cat <<EOF
Usage: $PROG --name NAME [options] -- COMMAND [ARGS...]

Run a command in a new tmux pane.

Options:
  --name NAME       Unique name for this pane (required)
  --prefix NAME     Session prefix (default: $DEFAULT_PREFIX)
  --dir PATH        Working directory for the command
  --env KEY=VALUE   Set environment variable (repeatable)
  --replace         Respawn a dead pane with the new command
  --quiet, -q       Suppress informational output
  --help            Show this help

Examples:
  $PROG --name build -- make -j4
  $PROG --name server -- python -m http.server 8000
  $PROG --name tests --env CI=true -- npm test
EOF
}

parse_args() {
    PREFIX="$DEFAULT_PREFIX"
    NAME=""
    DIR=""
    ENV_VARS=()
    CMD=()
    REPLACE=false
    QUIET=false
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --name) [[ $# -ge 2 ]] || { echo "Error: --name requires a value" >&2; exit 1; }; NAME="$2"; shift 2 ;;
            --prefix) [[ $# -ge 2 ]] || { echo "Error: --prefix requires a value" >&2; exit 1; }; PREFIX="$2"; shift 2 ;;
            --dir) [[ $# -ge 2 ]] || { echo "Error: --dir requires a value" >&2; exit 1; }; DIR="$2"; shift 2 ;;
            --env) [[ $# -ge 2 ]] || { echo "Error: --env requires a value" >&2; exit 1; }; ENV_VARS+=("$2"); shift 2 ;;
            --replace) REPLACE=true; shift ;;
            --quiet|-q) QUIET=true; shift ;;
            --help) usage; exit 0 ;;
            --) shift; CMD=("$@"); break ;;
            *) echo "Error: unknown argument '$1'" >&2; usage >&2; exit 1 ;;
        esac
    done
    if [[ -z "$NAME" ]]; then
        echo "Error: --name is required" >&2
        usage >&2
        exit 1
    fi
    if [[ ${#CMD[@]} -eq 0 ]]; then
        echo "Error: command required after --" >&2
        usage >&2
        exit 1
    fi
}

pane_exists() {
    tmux list-windows -t "$PREFIX" -F '#{window_name}' 2>/dev/null | grep -qxF -- "$1"
}

parse_args "$@"

source "$(dirname "$0")/_tmux-common"
validate_name "name" "$NAME" || exit 1
validate_name "prefix" "$PREFIX" || exit 1

if ! session_exists "$PREFIX"; then
    echo "Error: session '$PREFIX' does not exist" >&2
    exit 1
fi

if pane_exists "$NAME"; then
    if [[ "$REPLACE" == true ]]; then
        # Check if pane is dead before replacing
        PANE_DEAD=$(tmux list-windows -t "$PREFIX" -F '#{window_name}|#{pane_dead}' 2>/dev/null \
            | awk -F'|' -v name="$NAME" '$1 == name {print $2; exit}')
        if [[ "$PANE_DEAD" != "1" ]]; then
            echo "Error: pane '$NAME' is still running; cannot replace" >&2
            exit 1
        fi
    else
        echo "Error: pane '$NAME' already exists in session '$PREFIX'" >&2
        exit 1
    fi
fi

# Prefix command with env vars if any
if [[ ${#ENV_VARS[@]} -gt 0 ]]; then
    CMD=(env "${ENV_VARS[@]}" "${CMD[@]}")
fi

if [[ "$REPLACE" == true ]] && pane_exists "$NAME"; then
    # Respawn the existing dead pane with the new command
    tmux clear-history -t "$PREFIX:$NAME"
    if [[ -n "$DIR" ]]; then
        tmux respawn-pane -k -t "$PREFIX:$NAME" -c "$DIR" "${CMD[@]}"
    else
        tmux respawn-pane -k -t "$PREFIX:$NAME" "${CMD[@]}"
    fi
    [[ "$QUIET" == true ]] || echo "Replaced '$NAME' in session '$PREFIX'"
else
    # Create a new window, set remain-on-exit so the pane stays visible after
    # the command exits, then respawn-pane to run the actual command directly.
    # This preserves argument quoting (CMD[@]) and enables exit detection.
    if [[ -n "$DIR" ]]; then
        tmux new-window -t "$PREFIX" -n "$NAME" -c "$DIR"
    else
        tmux new-window -t "$PREFIX" -n "$NAME"
    fi
    tmux set-option -t "$PREFIX:$NAME" remain-on-exit on
    if [[ -n "$DIR" ]]; then
        tmux respawn-pane -k -t "$PREFIX:$NAME" -c "$DIR" "${CMD[@]}"
    else
        tmux respawn-pane -k -t "$PREFIX:$NAME" "${CMD[@]}"
    fi
    [[ "$QUIET" == true ]] || echo "Started '$NAME' in session '$PREFIX'"
fi
