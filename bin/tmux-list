#!/usr/bin/env bash
set -euo pipefail

PROG="tmux-list"
DEFAULT_PREFIX="agent"

usage() {
    cat <<EOF
Usage: $PROG [options]

List named panes in the agent session.

Options:
  --prefix NAME   Session prefix (default: $DEFAULT_PREFIX)
  --help          Show this help

Output format: NAME STATUS COMMAND
  STATUS is "running" or "exited(N)" where N is exit code.

Examples:
  $PROG                    # List all panes in "agent" session
  $PROG --prefix myagent   # List panes in "myagent" session
EOF
}

parse_args() {
    PREFIX="$DEFAULT_PREFIX"
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --prefix) PREFIX="$2"; shift 2 ;;
            --help) usage; exit 0 ;;
            *) echo "Error: unknown argument '$1'" >&2; usage >&2; exit 1 ;;
        esac
    done
}

parse_args "$@"

if ! tmux has-session -t "$PREFIX" 2>/dev/null; then
    exit 0
fi

tmux list-windows -t "$PREFIX" -F '#{window_name} #{pane_dead} #{pane_dead_status} #{pane_current_command}' 2>/dev/null | while read -r name dead dead_status cmd; do
    [[ "$name" == "_init" ]] && continue
    if [[ "$dead" == "1" ]]; then
        status="exited(${dead_status})"
    else
        status="running"
    fi
    echo "$name $status $cmd"
done
