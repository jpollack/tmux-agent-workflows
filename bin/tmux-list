#!/usr/bin/env bash
set -euo pipefail

PROG="tmux-list"
DEFAULT_PREFIX="agent"

usage() {
    cat <<EOF
Usage: $PROG [options]

List named panes in the agent session.

Options:
  --prefix NAME    Session prefix (default: $DEFAULT_PREFIX)
  --format FMT     Output format: text (default) or json
  --filter STATE   Filter by state: running or exited
  --help           Show this help

Output format (text): NAME STATUS COMMAND
  STATUS is "running" or "exited(N)" where N is exit code.

Output format (json): one JSON object per line with name, status, command,
  and exit_code (when exited) fields.

Examples:
  $PROG                          # List all panes in "agent" session
  $PROG --prefix myagent         # List panes in "myagent" session
  $PROG --format json            # JSON lines output
EOF
}

parse_args() {
    PREFIX="$DEFAULT_PREFIX"
    FORMAT="text"
    FILTER=""
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --prefix) [[ $# -ge 2 ]] || { echo "Error: --prefix requires a value" >&2; exit 1; }; PREFIX="$2"; shift 2 ;;
            --format) [[ $# -ge 2 ]] || { echo "Error: --format requires a value" >&2; exit 1; }; FORMAT="$2"; shift 2 ;;
            --filter) [[ $# -ge 2 ]] || { echo "Error: --filter requires a value" >&2; exit 1; }; FILTER="$2"; shift 2 ;;
            --help) usage; exit 0 ;;
            *) echo "Error: unknown argument '$1'" >&2; usage >&2; exit 1 ;;
        esac
    done
    if [[ "$FORMAT" != "text" && "$FORMAT" != "json" ]]; then
        echo "Error: --format must be 'text' or 'json'" >&2
        exit 1
    fi
    if [[ -n "$FILTER" && "$FILTER" != "running" && "$FILTER" != "exited" ]]; then
        echo "Error: --filter must be 'running' or 'exited'" >&2
        exit 1
    fi
}

parse_args "$@"

source "$(dirname "$0")/_tmux-common"
validate_name "prefix" "$PREFIX" || exit 1

if ! session_exists "$PREFIX"; then
    exit 0
fi

tmux list-windows -t "$PREFIX" -F '#{window_name}|#{pane_dead}|#{pane_dead_status}|#{pane_current_command}' 2>/dev/null | while IFS='|' read -r name dead dead_status cmd; do
    [[ "$name" == "_init" ]] && continue
    if [[ -n "$FILTER" ]]; then
        if [[ "$FILTER" == "running" && "$dead" == "1" ]]; then continue; fi
        if [[ "$FILTER" == "exited" && "$dead" != "1" ]]; then continue; fi
    fi
    if [[ "$dead" == "1" ]]; then
        status="exited(${dead_status})"
    else
        status="running"
    fi
    if [[ "$FORMAT" == "json" ]]; then
        # Escape backslashes and double quotes in command field
        safe_cmd="${cmd//\\/\\\\}"
        safe_cmd="${safe_cmd//\"/\\\"}"
        if [[ "$dead" == "1" ]]; then
            printf '{"name":"%s","status":"exited","exit_code":%s,"command":"%s"}\n' \
                "$name" "${dead_status:-null}" "$safe_cmd"
        else
            printf '{"name":"%s","status":"running","command":"%s"}\n' "$name" "$safe_cmd"
        fi
    else
        echo "$name $status $cmd"
    fi
done
